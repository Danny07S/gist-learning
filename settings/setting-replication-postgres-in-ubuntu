
Step-by-step :
Bagaimana Me-Setup PostgreSQL untuk High Availability dan Replikasi (Cadangan) menggunakan Hot Standby.
Silahkan dibaca sampai akhir tahap demi tahap, agar memahami maksud dan tujuan dari replication Postgres ini.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Tujuan 
- Set up sebuah dua mesin komputer (virtual box) yang telah running Postgres.
- Membuat sebuah tabel guestbook app untuk percobaan
- Menkonfigurasi primary server (server utama)
- Backup primary server ke server standby (server cadangan)
- Menkonfigurasi standby server to menjalankan Hot Standby mode. Hot Standby sendiri merupakan sebuah layanan dari Postgres.
- Memulai standby server dan mengetesnya.

# Setting up Komputer Engine instances Connecting remotely
Untuk membuat primary dan standby server, silahkan ikuti step by step disini : 
https://cloud.google.com/solutions/set-up-postgres

# Catatan untuk mengikuti tutorial ini :
- Kita tidak membutuhkan penggunaan pgAdmin didalam tutorial ini
- Iktui step by step installasi server sampai selesai
- Ikuti step Connecting remotely di dalam tutorial diatas sampai selesai
- Kita harus membuka port jaringan hanya sekali, setelah itu tidak
- Perhatikan alamat IP dari server masing-masing. Kita harus mengetahui ini ketika merubah konfigurasi.
- Pastikan port SSH sudah terbuka karena SSH server dibutuhkan didalam tutorial ini.

# Membuat tabel guestbook
Pada primary server, buat table sederhana bertujuan untuk melakukan pengetesan. Tabel ini berfungsi untuk menyimpan data 
visitor dari sebuah website, dimana visitor didalam website tersebut dapat membuat sebuah komentar. Data field tersebut 
sebagai berikut alamat email visitor, serial ID, date & time sekarang, dan text message dari visitor.

Jalankan SSH terminal pada primary server (server utama):
1. Jalankan root shell:
   # sudo -s

2. Jalankan PSQL untuk user postgres dan akses database dengan nama postgres:
   # sudo -u postgres psql postgres

3. Pada PSQL prompt, masukan command dibawah ini untuk membuat sebuah table:
   # CREATE TABLE guestbook (visitor_email text, vistor_id serial, date timestamp, message text);

4. Masukan sebuah entry data pada table:
   # INSERT INTO guestbook (visitor_email, date, message) VALUES ( 'jim@gmail.com', current_date, 'This is a test.');
   Kita akan melihat sebuah pesan konfirmasi yang berkata: INSERT 0 1.

5. Enter \q untuk exit dari PSQL prompt.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Jangan keluar dari root shell. Kita akan menggunakan root shell selama tutorial ini berlangsung.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Konfigurasi primary server (server utama)
Untuk mengkonfigurasi primary server, kita akan:
- Membuat sebuah user Postgres untuk replication aktivitas.
- Membuat directory to menyimpan berbagai archive file
- Mengedit dua file konfigurasi: pg_hba.conf & postgresql.conf

# Membuat sebuah user untuk replication
Untuk melakukan replication, Postgres membutuhkan sebuah user, juga memiliki role, dengan spesial permissions.
  - Pada primary server, jalankan printah berikut:
    # sudo -u postgres createuser -U postgres repuser -P -c 5 --replication
  
# Membuat arsip direktori
Membuat sebuah direktori untuk menyimpan sebuah file arsip. Diretori ini adalah subdirektori dari direktori data cluster, 
yang diberi nama utama secara default.
  - Pada SSH terminal primary server, ikuti perintah dibawah ini:
    # mkdir -p ../../var/lib/postgresql/main/mnt/server/archivedir

# Edit pg_hba.conf
File konfigurasi ini berisi pengaturan klien. Kita harus menambahkan sebuah entri untuk rapuser sebagai pengguna untuk
mengaktifkan replikasi.
  
  1. Edit file, untuk PostgreSQL versi 9.5, kita bisa menggunakan:
     # nano ../../etc/postgresql/9.5/main/pg_hba.conf
     
  2. Tambhankan dibagian akhir contoh replication berikut. Ganti <standby-IP> dengan IP external standby server:
     # Allow replication connections
     host     replication     repuser         <standby-IP>/32        md5
  
  3. Simpan dan close file.
  
# Edit postgresql.conf
Konfigurasi ini berisi pengatusan utama untuk Postgres. Disini, kita akan memodifikasi file untuk memungkinkan archiving & 
replication.

  1. Edit file. Di terminal untuk server utama, masukan perintah berikut:
     # nano ../../etc/postgresql/9.5/main/postgresql.conf
  
  2. Pada bagian WRITE AHEAD LOG dibagian setting, ubah  WAL level:
     # wal_level = hot_standby
  
  3. Pada bagian Archiving, ubah archive mode:
     # archive_mode = on
   
  4. Ubah value dari archive command. Pengaturan ini memberitahu Postgres untuk menulis file arsip ke direktori yang kita
     buat pada langkah sebelumnya:
     # archive_command = 'test ! -f /mnt/server/archivedir/%f && cp %p /mnt/server/archivedir/%f'

  5. Pada bagian REPLICATION, dibagian server pengirim (Sending Server) ubah value dari maksimum nomer 
     dari WAL sender processes:
     # max_wal_senders = 3
     Untuk tutorial ini nilai 3 mungkin cukup untuk melakuakn backup & replikasi.
     
  4. Save dan close file.
  
# Restart primary server
Sekarang kita sudah membuat sebuah perubahan didalam file konfigurasi, silahkan restart server untuk membuat perubahan 
efektif berjalan. 
   - Masukan perintah berikut:
     # sudo service postgresql restart

# Backup primary server ke standby server
Sebelum membuat perubahan pada standby server, stop service dari standby server. Pada SSH terminal untuk standby server,
ikuti perintah berikut ini.
   - Masukan perintah berikut pada standby server SSH terminal:
     # sudo service postgresql stop
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Catatan: Jangan menjalankan start service lagi sampai semua langkah konfigurasi & backup lengkap.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Menjalankan utilitas backup
Utilitas backup, memiliki nama pg_basebackup, akan menyalin file dari direktori data pada primary serve ke direktori
yang sama pada standby server.
   
   1. Pastikan kita menjalankan perintah di shell root. Di terminal SSH standby server, masukan perintah berikut:
      # sudo -s
      Terus menggunakan shell root pada tutorial ini.
      
   2. Utilitas tidak akan menimpa file yang sudah ada, sehingga kita harus mengubah nama direktori data standby server.
      Jalankan perintah berikut:
      # mv ../../var/lib/postgresql/9.5/main ../../var/lib/postgresql/9.3/main_old
   
   3. 












